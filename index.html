<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dobnqmfsg/image/upload/v1771827572/Untitled_design-removebg-preview_bj0uah.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tailwind Config & Custom Animations -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    keyframes: {
                        'fade-in': { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        'slide-up': { '0%': { opacity: '0', transform: 'translate(-50%, 20px)' }, '100%': { opacity: '1', transform: 'translate(-50%, 0)' } },
                        'spin': { 'from': { transform: 'rotate(0deg)' }, 'to': { transform: 'rotate(360deg)' } }
                    },
                    animation: {
                        'in': 'fade-in 0.2s ease-out forwards',
                        'slide-up': 'slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'spin-slow': 'spin 1s linear infinite'
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
        
        .animate-in { animation: in 0.2s ease-out forwards; }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        [contenteditable="true"] {
            outline: none;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
            display: inline-block;
            word-break: break-word;
            white-space: pre-wrap;
            min-width: 50px;
            width: 100%;
        }
.content-placeholder {
    color: #71717a; /* gray placeholder color */
}
.content-placeholder:focus {
    color: #f5f5f5; /* normal text color when typing */
}
        
        [contenteditable="true"]:not(:focus) {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        [contenteditable="true"]:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        [contenteditable="true"]:focus {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.2);
            white-space: pre-wrap;
            overflow: visible;
        }

        /* Custom Checkbox Styling */
        .check-box-btn.selected {
            background-color: white !important;
            border-color: white !important;
        }
        .check-box-btn.selected .check-inner {
            background-color: black !important;
            display: block !important;
        }

        /* Dropdown reset for the client select */
        .client-select-wrapper {
            position: relative;
            width: fit-content;
            min-width: 160px;
        }
        .client-select {
            appearance: none;
            background: #09090b; /* Zinc 950 */
            border: 1px solid #27272a; /* Zinc 800 */
            color: white;
            font-weight: 700;
            font-size: 0.875rem;
            cursor: pointer;
            width: 100%;
            padding: 8px 32px 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .client-select:hover {
            background: #18181b;
            border-color: #3f3f46;
        }
        .client-select:focus {
            outline: none;
            border-color: #52525b;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.05);
        }
        .client-select option {
            background: #18181b;
            color: white;
        }
        .select-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #71717a;
        }
/* Subrow Product Dropdown Fix */
.subrow-select-wrapper {
    position: relative;
    display: inline-block;
    width: 140px; /* fixed width to prevent table cell glitch */
    min-width: 140px;
}
.subrow-select {
    appearance: none;
    background: #09090b;
    border: 1px solid #27272a;
    color: white;
    font-weight: 500;
    font-size: 0.75rem; /* smaller for subrow */
    cursor: pointer;
    width: 100%;
    padding: 4px 24px 4px 8px;
    border-radius: 6px;
    transition: all 0.2s;
}
.subrow-select:hover {
    background: #18181b;
    border-color: #3f3f46;
}
.subrow-select:focus {
    outline: none;
    border-color: #52525b;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.05);
}
.subrow-select option {
    background: #18181b;
    color: white;
}
.subrow-select-wrapper .select-icon {
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: #71717a;
}
    </style>
</head>
<body class="bg-black text-zinc-300 font-sans selection:bg-white selection:text-black">

    <!-- Lock Screen Overlay -->
    <div id="lockScreen" class="fixed inset-0 z-[100] bg-black flex items-center justify-center p-6 transition-opacity duration-500">
        <div class="w-full max-w-[320px] space-y-4">
                <div class="w-full flex justify-center mb-2">
        <img src="https://res.cloudinary.com/dobnqmfsg/image/upload/v1770995309/Screenshot_2026-02-13_151541-removebg-preview_ifdgq3.png" alt="Profile" class="max-w-[120px] max-h-[120px] object-contain">
    </div>

    <!-- Spacer to move input/button slightly lower -->
    <div class="mt-4"></div>
            <div class="space-y-1.5">
                <label for="lockPassword" class="text-[10px] font-bold uppercase tracking-widest text-zinc-500 ml-1">Password</label>
                <input type="password" id="lockPassword" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-zinc-600 transition-all" placeholder="Enter Your Password Here">
            </div>
            <button id="lockNextBtn" onclick="handleLockSubmit()" class="w-full bg-white text-black font-bold py-3 rounded-xl hover:bg-zinc-200 transition-all flex items-center justify-center gap-2">
                <span id="btnText">Next</span>
                <div id="btnSpinner" class="hidden w-4 h-4 border-2 border-black/20 border-t-black rounded-full animate-spin-slow"></div>
            </button>
            <p id="lockError" class="text-red-500 text-[10px] text-center font-bold tracking-wider hidden">Access Denied Try Again
            </p>
        </div>
    </div>

    <div id="app-container" class="min-h-screen flex flex-col relative opacity-0 transition-opacity duration-700">
        
        <!-- Global Scroll Lock Overlay (No blur) -->
        <div id="scrollLockOverlay" class="hidden fixed inset-0 z-40 cursor-default pointer-events-auto bg-black/20"></div>

        <!-- Delete Confirmation Dialog (Bottom Center) -->
        <div id="deleteDialog" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 w-[340px] bg-zinc-900 border border-zinc-800 rounded-2xl p-6 z-50 animate-slide-up shadow-2xl">
            <h4 class="text-white font-bold text-lg mb-1">Delete Item?</h4>
            <p class="text-zinc-400 text-sm mb-6">This action cannot be undone. Are you sure you want to remove this record?</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteDialog()" class="flex-1 px-4 py-2.5 rounded-xl bg-zinc-800 text-white text-xs font-bold hover:bg-zinc-700 transition-all">Cancel</button>
                <button id="confirmDeleteBtn" class="flex-1 px-4 py-2.5 rounded-xl bg-red-500 text-white text-xs font-bold hover:bg-red-600 transition-all">Delete</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col pointer-events-auto">
            <header class="h-24 border-b-2 border-zinc-800 bg-black/50 backdrop-blur-md flex items-center justify-between px-8 sticky top-0 z-30 pointer-events-auto">
                <div class="flex-1">
                    <h1 class="text-white text-2xl font-bold tracking-tight" style="font-family: 'Avenir Next', 'Avenir', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;">
                        Invoice Generator
                    </h1>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative items-center pr-1 border-r border-zinc-800 flex" id="accountRef">
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <p class="text-white font-bold text-xs">Alex Rivera</p>
                                <p class="text-[9px] text-zinc-500 font-bold uppercase tracking-wider">Employee</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center overflow-hidden">
                                <img src="https://res.cloudinary.com/dobnqmfsg/image/upload/v1770995309/Screenshot_2026-02-13_151541-removebg-preview_ifdgq3.png" alt="Profile" class="w-full h-full object-cover transform -translate-y-0.5">
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 p-6 md:p-10 max-w-[1400px] w-full mx-auto relative">
                <div id="projectsTableContainer" class="bg-transparent transition-opacity">
                    <div class="pb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div>
                            <h3 id="tableDateHeader" class="text-white font-bold text-lg"></h3>
                            <p class="text-zinc-500 text-xs mt-0.5 tracking-wide font-normal">Create your invoice below.</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="invoiceBtn" onclick="handleGenerateInvoice()" class="flex items-center gap-2 px-4 py-2 bg-white/90 border border-transparent rounded-xl text-black text-xs font-normal hover:bg-white transition-all shadow-lg shadow-white/5">
    <span id="invoiceBtnText">Generate Invoice</span>
    <i id="invoiceBtnIcon" data-lucide="plus" class="w-[17px] h-[17px]" stroke-width="1.6"></i>
    <div id="invoiceSpinner" class="hidden w-4 h-4 border-2 border-black/20 border-t-black rounded-full animate-spin-slow"></div>
</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
<div id="notesSection" class="mt-4 mb-4">
    <label for="invoiceNotes" class="text-zinc-400 text-xs font-bold uppercase tracking-widest mb-1 block">Notes</label>
    <textarea id="invoiceNotes" rows="3" class="w-full bg-zinc-900 border border-zinc-800 text-white rounded-xl px-3 py-2 text-sm resize-none focus:outline-none focus:border-zinc-600" placeholder="Enter any notes here..."></textarea>
</div>
                        <table class="w-full text-left border-collapse table-fixed">
                            <thead>
                                <tr class="bg-zinc-900/30 border-b border-zinc-700">
                                    <th class="py-4 px-6 text-zinc-300 text-[10px] font-bold uppercase tracking-widest w-[80%]">
                                        <div class="flex items-center gap-3">
                                            <button onclick="toggleSelectAll()" id="selectAllBtn" class="check-box-btn w-4 h-4 rounded border border-zinc-600 bg-zinc-900 flex items-center justify-center transition-all">
                                                <div class="check-inner hidden w-1.5 h-1.5 bg-zinc-700 rounded-sm"></div>
                                            </button>
                                            Client Name
                                        </div>
                                    </th>
                                    <th class="py-4 px-6 text-zinc-300 text-[10px] font-bold uppercase tracking-widest text-right w-[20%]">No. of Projects</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-zinc-800">
                                <!-- Generated by JS -->
                            </tbody>
                        </table>
                        
                        <!-- Main Plus Button Container -->
                        <div class="w-full border-t border-zinc-800 flex justify-center py-4">
                            <button onclick="addNewClient()" class="w-8 h-8 rounded-full bg-zinc-900 border border-zinc-700 text-zinc-300 hover:text-white hover:border-zinc-400 flex items-center justify-center transition-all">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </main>

            <footer id="footer" class="py-8 px-10 border-t border-zinc-900 mt-10 transition-opacity">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <p class="text-zinc-600 text-[10px] uppercase tracking-[0.2em] font-bold">Â© Podcutz Systems</p>
                    <div class="flex items-center gap-8">
                        <button class="text-zinc-600 text-[10px] uppercase tracking-[0.2em] font-bold">
                            Creating Systems that sustain
                        </button>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // --- Lock Screen Logic ---
        // --- Lock Screen Logic ---
// --- Helper to get password from URL param ---
function getUrlParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
}
async function handleLockSubmit() {
    const passwordInput = document.getElementById('lockPassword');
    const errorText = document.getElementById('lockError');
    const password = passwordInput.value;

    if (!password) return;

    const btn = document.getElementById('lockNextBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');

    // UI loading state
    errorText.classList.add('hidden');
    btn.disabled = true;
    btnText.textContent = "";
    btnSpinner.classList.remove('hidden');

    try {
        // --- Get password for Basic Auth from URL ---
// --- Safe Basic Auth for n8n ---
function encodeBasicAuth(username, password) {
    return btoa(unescape(encodeURIComponent(username + ':' + password)));
}

const basicAuthPassword = getUrlParam('auth') || '';
const basicAuthHeader = 'Basic ' + encodeBasicAuth('noonehere', basicAuthPassword);

const response = await fetch('https://n8n.norkx.space/webhook/invsys3.0', {
    method: "POST",
    headers: { 
        "Content-Type": "application/json",
        "Authorization": basicAuthHeader
    },
    body: JSON.stringify({ password: password, timestamp: new Date().toISOString() })
});

        if (!response.ok) throw new Error(`Server error: ${response.status}`);

        const rawData = await response.json();
        const data = Array.isArray(rawData) ? rawData[0] : rawData;

        // --- Unlock check ---
        if (!data.result?.Password) throw new Error("Incorrect password");

        // --- Unlock UI ---
        const lockScreen = document.getElementById('lockScreen');
        const appContainer = document.getElementById('app-container');
        lockScreen.classList.add('opacity-0', 'pointer-events-none');
        appContainer.classList.remove('opacity-0');
        appContainer.classList.add('opacity-100');
        setTimeout(() => lockScreen.remove(), 500);

        // --- Set account name ---
const accountNameEl = document.querySelector('#accountRef p:first-child');
if (accountNameEl) accountNameEl.textContent = data.result.Name;

// --- Store JWT from response ---
window.jwtToken = data.jwt || '';

// --- Set clients for table ---
window.clients = data.clients.map((c, idx) => ({
    id: `client-${idx}-${Date.now()}`,
    name: c.client,
    status: 'Active',
    pm: 'Alex Rivera',
    products: c.products,
    projects: [] // initially empty
}));

        // Set client options for main row dropdown
        window.clientOptions = window.clients.map(c => c.name);

        // Set product options template for subrows (will filter per client)
        window.productOptions = []; // products will be dynamic per client

        renderTable();

    } catch (err) {
        console.error(err);
        errorText.classList.remove('hidden');
    } finally {
        btn.disabled = false;
        btnText.textContent = "Next";
        btnSpinner.classList.add('hidden');
    }
}
        
        // --- State ---
        let expandedRows = [];
let itemToDelete = null;
let generatedInvoiceLink = null; // NEW

        
        const productOptions = ["New Product", "Web Development", "Mobile App", "Backend API", "UI/UX Design", "Cloud Infrastructure", "Cybersecurity"];

        // --- Mock Data ---
        let clients = []; // will be populated dynamically from webhook response

        // --- DOM Elements ---
        const scrollLockOverlay = document.getElementById('scrollLockOverlay');
        const deleteDialog = document.getElementById('deleteDialog');
        const tableBody = document.getElementById('tableBody');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderDate();
            renderTable();
            lucide.createIcons();
        });

        function renderDate() {
            const date = new Date();
            const day = date.getDate();
            const month = date.toLocaleString('en-US', { month: 'long' });
            let suffix = (day % 10 === 1 && day !== 11) ? 'st' : (day % 10 === 2 && day !== 12) ? 'nd' : (day % 10 === 3 && day !== 13) ? 'rd' : 'th';
            document.getElementById('tableDateHeader').textContent = `${day}${suffix} ${month}`;
        }

        function handleKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
        }

        function handleNumericKeydown(e) {
            if ([46, 8, 9, 27, 13].indexOf(e.keyCode) !== -1 ||
                (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                (e.keyCode >= 35 && e.keyCode <= 40)) {
                return;
            }
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        }

        function cleanNumericInput(el) {
            el.innerText = el.innerText.replace(/[^0-9]/g, '');
        }

        // --- Core Table Logic ---
        function renderTable() {
            let html = '';
            clients.forEach(client => {
                const isExpanded = expandedRows.includes(client.id);

                html += `
                    <tr class="group transition-colors hover:bg-white/[0.02]">
                        <td class="py-5 px-6 align-top">
                            <div class="flex items-start gap-3 w-full min-w-0">
                                <div class="mt-1.5 flex items-center gap-3 shrink-0">
                                    <button onclick="promptDelete('client', '${client.id}', null, event)" class="check-box-btn w-4 h-4 rounded border border-zinc-600 bg-zinc-900 flex items-center justify-center transition-all">
                                        <div class="check-inner hidden w-1.5 h-1.5 bg-zinc-700 rounded-sm"></div>
                                    </button>
                                    <div onclick="toggleRow('${client.id}')" class="text-zinc-500 cursor-pointer transition-transform duration-200 ${isExpanded ? 'rotate-90 text-white' : ''}">
                                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3 flex-1 min-w-0">
                                    <div class="mt-2 w-8 h-8 rounded-lg bg-zinc-900 border border-zinc-800 flex items-center justify-center text-white shrink-0"><i data-lucide="briefcase" class="w-[14px] h-[14px]"></i></div>
                                    <div class="flex-1 relative">
                                        <div class="client-select-wrapper">
                                            <select onchange="updateValue('${client.id}', 'name', this.value)" class="client-select">
    ${window.clients.map(c => `<option value="${c.name}" ${client.name === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
    ${!window.clients.some(c => c.name === client.name) ? `<option value="${client.name}" selected>${client.name}</option>` : ''}
</select>
                                            <i data-lucide="chevron-down" class="select-icon w-3.5 h-3.5"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="py-5 px-6 text-right align-top">
                            <div class="mt-2.5">
                                <span class="text-white font-normal text-sm">${client.projects.length}</span>
                            </div>
                        </td>
                    </tr>
                `;

                if (isExpanded) {
                    html += `
                        <tr class="bg-zinc-950/50">
                            <td colspan="2" class="p-0 border-t border-zinc-800">
                                <table class="w-full text-left table-fixed">
                                    <thead>
                                        <tr class="border-b border-zinc-800">
    <th class="py-3 pl-40 text-zinc-400 text-[9px] font-bold uppercase tracking-widest w-[40%]">Product</th>
    <th class="py-3 px-6 text-zinc-400 text-[9px] font-bold uppercase tracking-widest text-right w-[20%]">Qty</th>
    <th class="py-3 px-6 text-zinc-400 text-[9px] font-bold uppercase tracking-widest text-left w-[40%]">Notes</th>
</tr>
                                    </thead>
                                    <tbody class="divide-y divide-zinc-800">
                                        ${client.projects.map(p => `
                                            <tr class="hover:bg-white/[0.01] transition-colors group/sub">
                                                <td class="py-4 pl-4 align-top">
                                                    <div class="flex items-center gap-6">
                                                        <button onclick="promptDelete('project', '${client.id}', ${p.id}, event)" class="check-box-btn w-4 h-4 rounded border border-zinc-700 bg-zinc-950 flex items-center justify-center transition-all shrink-0">
                                                            <div class="check-inner hidden w-1.5 h-1.5 bg-zinc-800 rounded-sm"></div>
                                                        </button>
                                                        <div class="flex-1 relative">
                                                            <div class="subrow-select-wrapper">
    <select onchange="updateSubValue('${client.id}', ${p.id}, 'type', this.value)" class="subrow-select">
        ${client.products.map(prod => `
            <option value="${prod}" ${p.type === prod ? 'selected' : ''}>${prod}</option>
        `).join('')}
        ${p.type && !client.products.includes(p.type) ? `<option value="${p.type}" selected>${p.type}</option>` : ''}
    </select>
    <i data-lucide="chevron-down" class="select-icon w-3 h-3"></i>
</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="py-4 px-6 align-top text-right">
    <div class="mt-1.5">
        <span contenteditable="true" 
              onkeydown="handleNumericKeydown(event)" 
              oninput="cleanNumericInput(this)"
              onblur="updateSubValue('${client.id}', ${p.id}, 'qty', this.innerText)" 
              class="text-zinc-400 text-xs">${p.qty || 1}</span>
    </div>
</td>
<td class="py-4 px-6 align-top text-left">
    <div class="mt-1.5">
        <span contenteditable="true"
      class="text-zinc-400 text-xs ${p.notesIsPlaceholder ? 'content-placeholder' : ''}"
      onfocus="handleNotesFocus(this, '${client.id}', ${p.id})"
      onblur="handleNotesBlur(this, '${client.id}', ${p.id})">
    ${p.notes || ''}
</span>
    </div>
</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="w-full border-t border-zinc-800 flex justify-center py-3 bg-zinc-900/10">
                                    <button onclick="addNewProject('${client.id}')" class="w-6 h-6 rounded-full border border-zinc-700 text-zinc-400 hover:text-white hover:border-zinc-400 flex items-center justify-center transition-all bg-black">
                                        <i data-lucide="plus" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            tableBody.innerHTML = html;
            lucide.createIcons();
        }

        // --- Interactive Actions ---
        window.toggleRow = function(id) {
            expandedRows = expandedRows.includes(id) ? expandedRows.filter(rid => rid !== id) : [...expandedRows, id];
            renderTable();
        }

        window.addNewClient = function() {
    const newId = `client-${Date.now()}`;
    clients.push({ 
        id: newId, 
        name: 'Select',  // <-- default placeholder
        status: 'Pending', 
        pm: 'Unassigned', 
        products: [], 
        projects: [] 
    });
    renderTable();
}

        window.addNewProject = function(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (client) {
        client.projects.push({
            id: Date.now(),
            projectName: 'New Project',
            type: 'Select',
            qty: 1,
            notes: 'Enter your text here',   // placeholder text
            notesIsPlaceholder: true,        // flag for placeholder
            completedAt: '-'
        });
        renderTable();
    }
}

        window.updateValue = function(id, field, value) {
    const client = clients.find(c => c.id === id);
    if (client) {
        client[field] = value.trim();

        // Update products dropdown for subrows based on selected client
        const matchedClient = window.clients.find(c => c.name === value.trim());
        client.products = matchedClient ? [...matchedClient.products] : [];

        // Update subrow product selections intelligently
        client.projects.forEach(p => {
            if (!client.products.includes(p.type)) {
                p.type = 'Select'; // reset only if old value not in new client
            }
        });

        renderTable();
    }
}

        window.updateSubValue = function(clientId, projectId, field, value) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                const project = client.projects.find(p => p.id === projectId);
                if (project) { project[field] = value.trim(); renderTable(); }
            }
        }

        // --- Selection Logic ---
        window.toggleSelectAll = function() {
            const btn = document.getElementById('selectAllBtn');
            const isSelected = btn.classList.toggle('selected');
            if (isSelected) { promptDelete('all', null, null, null); }
        }

        // --- Deletion Logic ---
        window.promptDelete = function(type, clientId, projectId = null, event = null) {
            itemToDelete = { type, clientId, projectId };
            const eventTarget = event?.currentTarget;
            if (eventTarget && eventTarget.classList.contains('check-box-btn')) { eventTarget.classList.add('selected'); }
            scrollLockOverlay.classList.remove('hidden');
            deleteDialog.classList.remove('hidden');
        }

        window.closeDeleteDialog = function() {
            itemToDelete = null;
            scrollLockOverlay.classList.add('hidden');
            deleteDialog.classList.add('hidden');
            document.querySelectorAll('.check-box-btn').forEach(btn => btn.classList.remove('selected'));
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            if (!itemToDelete) return;
            if (itemToDelete.type === 'client') {
                clients = clients.filter(c => c.id !== itemToDelete.clientId);
                expandedRows = expandedRows.filter(id => id !== itemToDelete.clientId);
            } else if (itemToDelete.type === 'project') {
                const client = clients.find(c => c.id === itemToDelete.clientId);
                if (client) { client.projects = client.projects.filter(p => p.id !== itemToDelete.projectId); }
            } else if (itemToDelete.type === 'all') {
                clients = [];
                expandedRows = [];
            }
            closeDeleteDialog();
            renderTable();
        });
async function handleGenerateInvoice() {
    const btn = document.getElementById('invoiceBtn');
    const btnText = document.getElementById('invoiceBtnText');
    const btnIcon = document.getElementById('invoiceBtnIcon');
    const spinner = document.getElementById('invoiceSpinner');

    // --- Build Structured Clean Payload ---
    const payload = [];
const notes = document.getElementById('invoiceNotes')?.value?.trim() || '';

    clients.forEach(client => {
        // Skip default client
        if (!client.name || client.name === "Select") return;

        const validProjects = client.projects
    .filter(p => p.type && p.type !== "Select")
    .map(p => ({
        product: p.type,
        qty: Number(p.qty) || 1,
        notes: p.notes || ''
    }));

        if (validProjects.length > 0) {
            payload.push({
                client: client.name,
                projects: validProjects
            });
        }
    });

    if (payload.length === 0) {
        alert("No valid invoice data to send.");
        return;
    }

    // --- UI Loading State ---
    btn.disabled = true;
    btnText.textContent = "Generating...";
    btnIcon.classList.add("hidden");
    spinner.classList.remove("hidden");

    // --- Get account holder name from header ---
// --- Get account holder name from header ---
const accountName =
    document.querySelector('#accountRef p:first-child')?.textContent?.trim() || "Unknown";

try {
    const response = await fetch("https://n8n.norkx.space/webhook/invsys3.1", {
    method: "POST",
    headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${window.jwtToken || ''}`
    },
    body: JSON.stringify({
    timestamp: new Date().toISOString(),
    accountHolder: accountName,
    data: payload,
    notes: notes
})
});

    if (!response.ok) {
        throw new Error("Webhook failed");
    }

    const result = await response.json();

// Extract link safely
const invoiceData = Array.isArray(result) ? result[0] : result;

if (!invoiceData?.webViewLink) {
    throw new Error("Invalid webhook response");
}

generatedInvoiceLink = invoiceData.webViewLink;

// Render invoice screen
renderInvoiceView(accountName);

} catch (err) {
    console.error(err);
    alert("Invoice generation failed.");
} finally {
        // --- Reset Button ---
        btn.disabled = false;
        btnText.textContent = "Generate Invoice";
        btnIcon.classList.remove("hidden");
        spinner.classList.add("hidden");
    }
}
function renderInvoiceView(accountName) {
    const tableContainer = document.getElementById('projectsTableContainer');
document.getElementById('invoiceNotes').value = '';

    tableContainer.innerHTML = `
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse table-fixed">
                <thead>
                    <tr class="bg-zinc-900/30 border-b border-zinc-700">
                        <th class="py-4 px-6 text-zinc-300 text-[10px] font-bold uppercase tracking-widest">
                            Invoice
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-zinc-800">
                    <tr class="hover:bg-white/[0.02] transition-colors">
                        <td class="py-6 px-6">
                            <div class="flex items-center justify-between">
                                <span class="text-white text-sm font-medium">
                                    ${accountName}'s Invoice
                                </span>
                                <button 
                                    onclick="window.open(generatedInvoiceLink, '_blank')"
                                    class="text-zinc-400 hover:text-white transition-all"
                                >
                                    <i data-lucide="arrow-up-right" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;

    lucide.createIcons();
}
function handleNotesFocus(el, clientId, projectId) {
    const client = clients.find(c => c.id === clientId);
    const project = client?.projects.find(p => p.id === projectId);
    if (project && project.notesIsPlaceholder) {
        el.innerText = '';                 // clear placeholder
        el.classList.remove('content-placeholder');
        project.notesIsPlaceholder = false; // mark as real input
    }
}

function handleNotesBlur(el, clientId, projectId) {
    const client = clients.find(c => c.id === clientId);
    const project = client?.projects.find(p => p.id === projectId);
    if (project) {
        const value = el.innerText.trim();
        if (!value) {
            // restore placeholder
            project.notes = 'Enter your text here';
            project.notesIsPlaceholder = true;
            el.innerText = project.notes;
            el.classList.add('content-placeholder');
        } else {
            project.notes = value;
            project.notesIsPlaceholder = false;
        }
    }
    renderTable(); // refresh table to reflect changes
}
    </script>
</body>
</html>
